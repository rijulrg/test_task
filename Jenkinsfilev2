pipeline {
    agent any
    stages{
        stage('test') {
            def myTestContainer = docker.image('node:8')
            myTestContainer.pull()
            myTestContainer.inside {
                sh 'cd app/'
                sh 'npm install'
                sh 'npm start'
                }
            }
        stage('docker build/push') {
            docker.withRegistry('https://index.docker.io/v1/', 'dockerhub') {
                def app = docker.build("rijulrg/podinfo:${BUILD_NUMBER}", '.').push()
                }
            }
        stage('deployment') {
            withKubeConfig([credentialsId: 'kubernetes']) {
                sh 'cat deployment.yaml | sed "s/{{BUILD_NUMBER}}/$BUILD_NUMBER/g" | kubectl apply -f -'
                sh 'kubectl apply -f service.yaml'
                }
            }
}                                          